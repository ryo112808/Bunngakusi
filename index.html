<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>文学史4択</title>
<style>
:root{--bg:#f6f7fb;--c:#fff;--b:#e5e7eb;--t:#0f172a;--m:#64748b;--p:#4f46e5;--ok:#16a34a;--ng:#ef4444}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--t);font:16px/1.45 system-ui}
.w{max-width:900px;margin:0 auto;padding:12px 12px calc(185px + env(safe-area-inset-bottom))}
.card{background:var(--c);border:1px solid var(--b);border-radius:16px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
h1{font-size:15px;margin:2px 0 8px}
.r{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button,textarea{font:inherit}
select,button{padding:10px 12px;border:1px solid var(--b);border-radius:14px;background:#fff}
button.p{background:var(--p);color:#fff;border-color:transparent}
.ta{width:100%;min-height:140px;border:1px solid var(--b);border-radius:14px;padding:10px;font:12.5px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace}
.s{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--m);font-size:13px}
.bar{flex:1;min-width:160px;height:10px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;overflow:hidden}
.bar i{display:block;height:100%;width:0;background:var(--p)}
.q{font-size:18px;margin:10px 0 0;white-space:pre-wrap}
.bad{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;color:var(--m);font-size:13px}
.pill{border:1px solid var(--b);background:#fff;border-radius:999px;padding:6px 10px}
.dock{position:fixed;left:0;right:0;bottom:0;padding:10px 10px calc(10px + env(safe-area-inset-bottom));
background:rgba(246,247,251,.92);backdrop-filter:blur(10px);border-top:1px solid var(--b)}
.opts{max-width:900px;margin:0 auto;display:grid;gap:8px}
.opt{width:100%;text-align:left;padding:16px;border-radius:16px;border:1px solid var(--b);background:#fff;font-size:17px}
.k{display:inline-grid;place-items:center;width:1.7em;height:1.7em;border-radius:10px;border:1px solid var(--b);margin-right:.55em;color:var(--m);font:12px ui-monospace}
.opt.ok{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.10)}
.opt.ng{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)}
#ans{margin-top:10px;border-radius:16px;padding:14px 14px;border:1px solid var(--b);display:none}
#ans b{font-size:22px;display:block}
#ans small{display:block;margin-top:6px;color:rgba(255,255,255,.92);font-weight:650}
#ans.ok{background:var(--ok);border-color:transparent;color:#fff}
#ans.ng{background:var(--ng);border-color:transparent;color:#fff}
</style>

<div class="w">
  <div class="card">
    <h1>文学史4択（w最小→ランダム / 正解でw+1 / 目標T回）</h1>
    <div class="r">
      <label class="s">T <select id="T"><option>1</option><option selected>2</option></select></label>
      <label class="s">難 <select id="D"><option value="1">1</option><option value="2" selected>2</option><option value="3">3</option></select></label>
      <button class="p" id="go">開始/再開</button>
      <button id="rs">このソース範囲だけ初期化</button>
    </div>

    <div class="s" style="margin-top:10px"><span id="st">0%</span><div class="bar"><i id="fi"></i></div><span id="meta">-</span></div>
    <div class="bad"><span class="pill" id="cnt">items:0 / facts:0</span><span class="pill" id="miss">miss:0</span></div>

    <textarea id="src" class="ta" placeholder="ここに｜区切りソースを貼る（1行=1データ、ベタ貼りも可）"></textarea>

    <div id="ans"></div>
    <div class="q" id="q">ソースを貼って開始</div>
  </div>
</div>

<div class="dock" id="dock" style="display:none"><div class="opts" id="opts"></div></div>

<script>
let IT=[],F=[],W={},M={},T=2,D=2,ANS="",LK="",LOCK=0,REV=0,Q=null;
const $=id=>document.getElementById(id),U=a=>[...new Set(a)],S=a=>a.sort(()=>Math.random()-.5),R=a=>a[(Math.random()*a.length)|0];
const LS="bungaku_v4",LSS="bungaku_src_v4";
const dash=s=>(s||"").replace(/[―—−‐-–－]/g,"-").replace(/\uFFFD/g,"").replace(/\s+/g," ").trim();
const na=s=>!s||s==="-"||s==="作者不詳"||s==="不詳"||s==="不明";
const splitW=s=>dash(s).split(/[／/]/).map(dash).filter(x=>x&&!na(x));
const tags=s=>dash(s).replace(/＝/g," ").replace(/[（）()]/g," ").split(/[／/・,、\s]+/).map(dash).filter(x=>x&&!na(x));
const eraO={"上代":0,"中古":1,"平安":1,"鎌倉":2,"中世":3,"室町":3,"江戸":4,"近世":4,"明治":5,"大正":6,"昭和前期":7,"戦後":8,"現代":9};
const eras=Object.keys(eraO).sort((a,b)=>eraO[a]-eraO[b]);
const near=e=>{let v=eraO[e];if(v==null)return[];let i=eras.indexOf(e),o=[];for(let d=1;d<4;d++){eras[i-d]&&o.push(eras[i-d]);eras[i+d]&&o.push(eras[i+d])}return o};
let P={A:[],W:[],E:[],aE:{},aG:{},aT:{},wE:{},wG:{},wT:{},wA:{},aW:{}},add=(m,k,v)=>(m[k]=m[k]||[]).push(v);

function loadAll(){try{return JSON.parse(localStorage.getItem(LS)||"{}")}catch(e){return{}}}
function saveAll(o){localStorage.setItem(LS,JSON.stringify(o))}
function loadWM(){let o=loadAll();W=o.W||{};M=o.M||{}}
function saveWM(){let o=loadAll();o.W=W;o.M=M;saveAll(o)}

function buildPools(){
  P={A:[],W:[],E:[],aE:{},aG:{},aT:{},wE:{},wG:{},wT:{},wA:{},aW:{}};
  for(let x of IT){
    let {era,gen,author,work,ts}=x;
    if(era&&!na(era)) P.E.push(era);
    if(author&&!na(author)){P.A.push(author);add(P.aE,era,author);add(P.aG,gen,author);for(let t of ts)add(P.aT,t,author)}
    if(work&&!na(work)){
      P.W.push(work);add(P.wE,era,work);add(P.wG,gen,work);for(let t of ts)add(P.wT,t,work);
      if(author&&!na(author)){add(P.wA,author,work);add(P.aW,work,author)}
    }
  }
  for(let k of ["A","W","E"]) P[k]=U(P[k]);
  for(let m of ["aE","aG","aT","wE","wG","wT","wA","aW"]) for(let k in P[m]) P[m][k]=U(P[m][k].filter(v=>v&&!na(v)));
}

function buildFacts(){
  F=[];
  const push=(k,o)=>F.push({k,...o});
  for(let w of P.W){
    let as=U((P.aW[w]||[]).filter(x=>!na(x)));
    if(as.length===1){
      let a=as[0], x=IT.find(z=>z.work===w&&z.author===a)||IT.find(z=>z.work===w)||{};
      if(!na(a)) push("WA|"+w,{t:"WA",w,ans:a,era:x.era||"",gen:x.gen||"",tag:(x.ts?.[0]||"")});
      if(x.era&&!na(x.era)) push("WE|"+w,{t:"WE",w,ans:x.era,era:x.era,gen:x.gen||"",tag:(x.ts?.[0]||"")});
      let ns=U((x.ns||[]).filter(n=>n.length>=2&&n.length<=12&&!na(n)));
      for(let n of ns.slice(0,2)) push("NW|"+n+"|"+w,{t:"NW",n,w,ans:w,era:x.era||"",gen:x.gen||"",tag:(x.ts?.[0]||"")});
    }
  }
  for(let a of P.A){
    let ws=U((P.wA[a]||[]).filter(x=>!na(x)));
    if(ws.length>=2){let x=IT.find(z=>z.author===a)||{};push("AW|"+a,{t:"AW",a,ws,ans:R(ws),era:x.era||"",gen:x.gen||"",tag:(x.ts?.[0]||"")})}
  }
  for(let t in P.aT){
    let as=U(P.aT[t].filter(x=>!na(x)));
    if(as.length>=2){let x=IT.find(z=>(z.ts||[]).includes(t)&&z.author&&!na(z.author))||{};push("TA|"+t,{t:"TA",tag:t,ans:R(as),era:x.era||"",gen:x.gen||""})}
  }
  F=F.filter(f=>!na(f.ans));
  $("cnt").textContent=`items:${IT.length} / facts:${F.length}`;
}

function normalizeSrc(s){
  s=(s||"").replace(/\r/g,"");
  // ベタ貼り（スペース区切り）を「時代｜」で自動改行
  s=s.replace(/(上代｜|平安｜|中古｜鎌倉｜中世｜室町｜江戸｜近世｜明治｜大正｜昭和前期｜戦後｜現代｜)/g,"\n$1");
  return s;
}

function parse(src){
  src=normalizeSrc(src);
  let lines=src.split("\n").map(dash).map(s=>s.trim()).filter(l=>l&&l.includes("｜")&&!/^(※|ウィキ|Wikipedia|ほかに)/.test(l)&&!/件$/.test(l));
  IT=[];
  for(let l of lines){
    let a=l.split("｜").map(dash);
    if(a.length<6) continue;
    let [era,gen,tag,author,work,note]=a.slice(0,6);
    let ws=splitW(work), ts=tags(tag), ns=tags(note);
    for(let w of ws) IT.push({era,gen,tag,author,work:w,ts,ns,note});
  }
  buildPools(); buildFacts();
}

function prog(){
  let ks=F.map(f=>f.k), n=ks.length||1;
  let done=ks.filter(k=>(W[k]||0)>=T).length;
  let part=ks.reduce((s,k)=>s+Math.min(W[k]||0,T),0)/(n*T);
  $("st").textContent=`${(part*100).toFixed(1)}%  (${done}/${n})`;
  $("fi").style.width=(part*100)+"%";
  let minw=ks.length?Math.min(...ks.map(k=>W[k]||0)):0;
  $("meta").textContent=`minw=${minw}  T=${T}`;
  // miss（このfacts範囲だけ合計）
  let ms=ks.reduce((s,k)=>s+(M[k]||0),0);
  $("miss").textContent=`miss:${ms}`;
  return done===n && ks.length>0;
}

function take(arr,a){for(let v of S(U(arr||[]))) if(v&&!na(v)&&v!==ANS&&!a.includes(v)&&a.length<3) a.push(v)}

function pickPool(kind,f){
  let a=[],era=f.era||"",gen=f.gen||"",tag=f.tag||"";
  if(kind==="A"){
    if(D>=1) take(P.aE[era],a);
    if(D>=2) take(P.aG[gen],a);
    if(D>=3&&tag) take(P.aT[tag],a);
    if(D>=3) for(let e of near(era)) take(P.aE[e],a);
    take(P.A,a);
  }else if(kind==="W"){
    if(D>=1) take(P.wE[era],a);
    if(D>=2) take(P.wG[gen],a);
    if(D>=3&&tag) take(P.wT[tag],a);
    if(D>=3&&f.a) take(P.wA[f.a],a);
    if(D>=3) for(let e of near(era)) take(P.wE[e],a);
    take(P.W,a);
  }else{
    take(near(ANS),a); take(P.E,a);
  }
  return a;
}

function makeQ(f){
  let q,opts=[];
  if(f.t==="WA"){q=`『${f.w}』の作者は？`;ANS=f.ans;opts=S([ANS,...pickPool("A",f)])}
  else if(f.t==="AW"){q=`${f.a} の代表作として適切なのは？`;ANS=f.ans;opts=S([ANS,...pickPool("W",{...f,a:f.a})])}
  else if(f.t==="TA"){q=`「${f.tag}」に関連する作家は？`;ANS=f.ans;opts=S([ANS,...pickPool("A",f)])}
  else if(f.t==="NW"){q=`次のキーワードから連想される作品は？\n「${f.n}」`;ANS=f.ans;opts=S([ANS,...pickPool("W",f)])}
  else {q=`『${f.w}』の時代は？`;ANS=f.ans;opts=S([ANS,...pickPool("E",f)])}
  opts=opts.filter(v=>v&&!na(v));
  while(opts.length<4){
    let v=q.includes("作者")||q.includes("作家")?R(P.A):q.includes("時代")?R(P.E):R(P.W);
    if(v&&!na(v)&&v!==ANS&&!opts.includes(v)) opts.push(v)
  }
  return {q,opts:opts.slice(0,4),k:f.k};
}

function pickFact(){
  let min=1e9,c=[];
  for(let f of F){let w=W[f.k]||0; if(w<min){min=w;c=[f]} else if(w===min)c.push(f)}
  return R(c);
}

function showAns(ok){
  let a=$("ans");
  a.className=ok?"ok":"ng";
  a.innerHTML=`<b>${ok?"○ 正解":"× 不正解"}</b><small>答え：${ANS}（画面タップで次へ）</small>`;
  a.style.display="block";
}

function hideAns(){ $("ans").style.display="none" }

function render(Q){
  $("dock").style.display="block";
  $("q").textContent=Q.q;
  $("opts").innerHTML=Q.opts.map((v,i)=>`<button class="opt" data-v="${v}"><span class="k">${i+1}</span>${v}</button>`).join("");
  [...document.querySelectorAll(".opt")].forEach(b=>b.onclick=e=>{e.stopPropagation();judge(b,Q)});
}

function show(){
  hideAns(); REV=0;
  if(!F.length){$("q").textContent="データ行を確認：1行=6列（時代｜ジャンル｜区分/運動｜作者｜作品｜メモ）"; $("dock").style.display="none"; prog(); return;}
  if(prog()){ $("q").textContent="✅ クリア！"; $("opts").innerHTML=""; $("dock").style.display="none"; return; }
  let f=pickFact(); LK=f.k; Q=makeQ(f); render(Q);
}

function judge(btn,Q){
  if(LOCK||REV) return; LOCK=1; REV=1;
  let v=btn.dataset.v, ok=v===ANS;

  [...document.querySelectorAll(".opt")].forEach(b=>{
    let bv=b.dataset.v;
    if(bv===ANS) b.classList.add("ok");
    else if(bv===v) b.classList.add("ng");
    b.disabled=true;
  });

  if(ok) W[LK]=(W[LK]||0)+1;
  else M[LK]=(M[LK]||0)+1;
  saveWM(); prog(); showAns(ok);

  // 次へ：全画面タップ or Enter/Space
  setTimeout(()=>LOCK=0,0);
}

function start(){
  T=+$("T").value; D=+$("D").value;
  let s=$("src").value||"";
  localStorage.setItem(LSS,s);
  parse(s);
  loadWM();
  prog(); show();
}

function resetCurrent(){
  let s=$("src").value||"";
  localStorage.setItem(LSS,s);
  parse(s);
  loadWM();
  // 今回factsに紐づくキーだけ初期化
  for(let f of F){delete W[f.k]; delete M[f.k]}
  saveWM(); prog(); show();
}

document.addEventListener("click",e=>{
  if(!REV) return;
  e.preventDefault(); e.stopPropagation();
  REV=0; show();
},true);

addEventListener("keydown",e=>{
  if(REV&&(e.key==="Enter"||e.key===" ")){REV=0;show();return;}
  let k=+e.key; if(k>=1&&k<=4){let b=[...document.querySelectorAll(".opt")][k-1]; b&&b.click();}
});

$("go").onclick=start;
$("rs").onclick=resetCurrent;

$("src").value=localStorage.getItem(LSS)||"";
if($("src").value.trim()) setTimeout(start,60);
</script>
