<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>文学史 4択</title>
<style>
:root{--bg:#f6f7fb;--card:#fff;--b:#e5e7eb;--t:#0f172a;--m:#64748b;--pri:#4f46e5;--ok:#059669;--ng:#dc2626}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--t);font:16px/1.45 system-ui}
.wrap{max-width:920px;margin:0 auto;padding:12px 12px calc(140px + env(safe-area-inset-bottom))}
.top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
h1{font-size:16px;margin:4px 0}
.card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button{font:inherit}select{padding:10px 12px;border:1px solid var(--b);border-radius:14px;background:#fff}
.btn{padding:10px 12px;border:1px solid var(--b);border-radius:14px;background:#fff}
.btn.pri{background:var(--pri);border-color:transparent;color:#fff}
.ta{width:100%;min-height:140px;border:1px solid var(--b);border-radius:14px;padding:10px;font:12.5px/1.5 ui-monospace,SFMono-Regular,Menlo,monospace}
.stat{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--m);font-size:13px}
.bar{flex:1;min-width:170px;height:10px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;overflow:hidden}
.bar i{display:block;height:100%;width:0;background:var(--pri)}
.q{font-size:18px;margin:6px 0 0}
.sub{color:var(--m);font-size:12px;margin-top:8px;white-space:pre-wrap}
.dock{position:fixed;left:0;right:0;bottom:0;padding:10px 10px calc(10px + env(safe-area-inset-bottom));
background:rgba(246,247,251,.92);backdrop-filter:blur(10px);border-top:1px solid var(--b)}
.opts{max-width:920px;margin:0 auto;display:grid;gap:8px;grid-template-columns:1fr}
@media(min-width:720px){.opts{grid-template-columns:1fr 1fr}}
.opt{width:100%;text-align:left;padding:14px 14px;border-radius:16px;border:1px solid var(--b);background:#fff;font-size:16px}
.opt:active{transform:translateY(1px)}
.k{display:inline-grid;place-items:center;width:1.6em;height:1.6em;border-radius:10px;border:1px solid var(--b);margin-right:.55em;color:var(--m);font:12px ui-monospace}
.pill{display:inline-block;padding:2px 8px;border:1px solid var(--b);border-radius:999px;background:#fff;color:var(--m);font-size:12px}
.ok{color:var(--ok)}.ng{color:var(--ng)}
</style>

<div class="wrap">
  <div class="top">
    <div>
      <h1>文学史 4択（w最小→ランダム / 正解でw+1 / 目標T回）</h1>
      <div class="row">
        <span class="pill">スマホ親指最優先</span>
        <span class="pill">同棚ダミー強化</span>
        <span class="pill">入試形式ミックス</span>
      </div>
    </div>
    <div class="row">
      <label class="stat">T
        <select id="T"><option value="1">1</option><option value="2" selected>2</option></select>
      </label>
      <button class="btn pri" id="go">開始/再開</button>
      <button class="btn" id="rs">リセット</button>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div class="stat">
      <span id="stat">ソース未読み込み</span>
      <div class="bar"><i id="fill"></i></div>
      <span class="pill">1〜4で回答</span>
    </div>
    <textarea id="src" class="ta" placeholder="ここに｜区切りソースを貼る（1行=1データ）"></textarea>
  </div>

  <div class="card" id="quiz" style="margin-top:10px;display:none">
    <div class="q" id="q">-</div>
    <div class="sub" id="fb"></div>
  </div>
</div>

<div class="dock" id="dock" style="display:none">
  <div class="opts" id="opts"></div>
</div>

<script>
let I=[],W=[],T=2,cur=-1,ANS="",KEY="",LS="bungaku_w_mobile_v2";
const $=id=>document.getElementById(id),R=a=>a[(Math.random()*a.length)|0],S=a=>a.sort(()=>Math.random()-.5),U=a=>[...new Set(a)];
const norm=s=>s.replace(/\r/g,"").trim();
const H=s=>{let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))|0;return h+""};
const splitWorks=s=>s.split(/[／/]/).map(x=>x.trim()).filter(Boolean);
const cleanLine=l=>!/^(※|ウィキ|Wikipedia)/.test(l)&&!/^\S+\s*\(.+\)$/.test(l);

let P={}; // pools

function parse(src){
  let lines=norm(src).split("\n").map(x=>x.trim()).filter(x=>x&&x.includes("｜")&&cleanLine(x));
  I=lines.map((l,i)=>{
    let [era,genre,tag,author,work,note]=l.split("｜").map(x=>x.trim());
    return {i,era,genre,tag,author,work,note,l,works:work&&work!=="-"?splitWorks(work):[]};
  }).filter(x=>(x.author&&x.author!=="-")||(x.work&&x.work!=="-")||(x.tag&&x.tag!=="-"));
  buildPools();
}

function buildPools(){
  let allA=U(I.map(x=>x.author).filter(x=>x&&x!=="-"));
  let allW=U(I.flatMap(x=>x.works).filter(Boolean));
  let allE=U(I.map(x=>x.era).filter(Boolean));
  P={allA,allW,allE,
    aByEra:{},aByGenre:{},aByTag:{},
    wByEra:{},wByGenre:{},wByTag:{},
    wByAuthor:{}, aByWork:{}
  };
  for(let x of I){
    let e=x.era,g=x.genre,t=x.tag,a=x.author,w=x.works;
    if(a&&a!=="-"){
      (P.aByEra[e]=P.aByEra[e]||[]).push(a);
      (P.aByGenre[g]=P.aByGenre[g]||[]).push(a);
      if(t&&t!=="-")(P.aByTag[t]=P.aByTag[t]||[]).push(a);
    }
    if(w.length){
      (P.wByEra[e]=P.wByEra[e]||[]).push(...w);
      (P.wByGenre[g]=P.wByGenre[g]||[]).push(...w);
      if(t&&t!=="-")(P.wByTag[t]=P.wByTag[t]||[]).push(...w);
      if(a&&a!=="-")(P.wByAuthor[a]=P.wByAuthor[a]||[]).push(...w);
      for(let ww of w)(P.aByWork[ww]=P.aByWork[ww]||[]).push(a);
    }
  }
  // unique化
  for(let k of ["aByEra","aByGenre","aByTag","wByEra","wByGenre","wByTag","wByAuthor","aByWork"])
    for(let kk in P[k]) P[k][kk]=U(P[k][kk].filter(x=>x&&x!=="-"));
}

function loadState(k){
  let o={}; try{o=JSON.parse(localStorage.getItem(LS)||"{}")}catch(e){}
  let a=(o[k]?.w)||[];
  return a.slice(0,I.length).concat(Array(Math.max(0,I.length-a.length)).fill(0));
}
function saveState(){
  let o={}; try{o=JSON.parse(localStorage.getItem(LS)||"{}")}catch(e){}
  o[KEY]={w:W,ts:Date.now()}; localStorage.setItem(LS,JSON.stringify(o));
}

function prog(){
  let n=I.length, m=W.filter(x=>x>=T).length, sm=W.reduce((s,x)=>s+Math.min(x,T),0)/(n*T||1);
  $("stat").textContent=`${m}/${n}（${(m*100/(n||1)).toFixed(1)}%） 途中:${(sm*100).toFixed(1)}% minw=${Math.min(...W,0)}`;
  $("fill").style.width=(m*100/(n||1))+"%";
  return n && m===n;
}

function pick(){
  let min=Math.min(...W), idx=[];
  for(let i=0;i<I.length;i++) if(W[i]===min) idx.push(i);
  return R(idx);
}

// 同棚ダミー生成（優先: era -> genre -> tag -> global）
function distractors(type,x,ans){
  let a=[];
  const take=(pool)=>{for(let v of S(U(pool||[]))) if(v&&v!==ans&&!a.includes(v)&&a.length<3) a.push(v);};
  if(type==="A"){ // author choices
    take(P.aByEra[x.era]); take(P.aByGenre[x.genre]); if(x.tag&&x.tag!=="-") take(P.aByTag[x.tag]); take(P.allA);
  }else if(type==="W"){ // work choices
    take(P.wByEra[x.era]); take(P.wByGenre[x.genre]); if(x.tag&&x.tag!=="-") take(P.wByTag[x.tag]);
    if(x.author&&x.author!=="-") take(P.wByAuthor[x.author]);
    take(P.allW);
  }else if(type==="E"){ // era choices (入試の紛らわしさ: 近い並びを優先)
    let order=["上代","平安","中古","鎌倉","中世","室町","近世","江戸","近代","明治","大正","昭和前期","昭和","戦後","現代"];
    let i=order.indexOf(ans), near=[];
    if(i>-1){ for(let d=1;d<6;d++){ if(order[i-d]) near.push(order[i-d]); if(order[i+d]) near.push(order[i+d]); } }
    take(near); take(P.allE);
  }
  return a;
}

// 入試形式ミックス（重み：作品↔作者を厚め）
function makeQ(x){
  let modes=[];
  if(x.works.length && x.author && x.author!=="-"){ modes.push("W2A","A2W"); }
  if(x.tag && x.tag!=="-" && x.author && x.author!=="-"){ modes.push("T2A"); }
  if(x.works.length){ modes.push("W2E"); }
  // 作品↔作者を多めに出す
  let pickMode=R(modes.concat(modes).concat(["W2A","A2W"]).filter(Boolean));
  let q="",ans="",opts=[],meta=`${x.era}｜${x.genre}｜${x.tag}｜${x.author}｜${x.work}｜${x.note}`;
  if(pickMode==="W2A"){
    let w=R(x.works); q=`『${w}』の作者は？`; ans=x.author;
    opts=S([ans,...distractors("A",x,ans)]);
  }else if(pickMode==="A2W"){
    q=`${x.author} の代表作は？`; ans=R(x.works);
    opts=S([ans,...distractors("W",x,ans)]);
  }else if(pickMode==="T2A"){
    q=`「${x.tag}」の作家として適切なのは？`; ans=x.author;
    opts=S([ans,...distractors("A",x,ans)]);
  }else{ // W2E
    let w=R(x.works); q=`『${w}』の時代は？`; ans=x.era;
    opts=S([ans,...distractors("E",x,ans)]);
  }
  // 4択に整形（足りないとき全体補完）
  while(opts.length<4){
    let fill=(q.includes("作者")||q.includes("作家"))?R(P.allA):q.includes("時代")?R(P.allE):R(P.allW);
    if(fill&&fill!==ans&&!opts.includes(fill)) opts.push(fill);
  }
  return {q,ans,opts:opts.slice(0,4),meta};
}

function render(Q){
  $("quiz").style.display="block"; $("dock").style.display="block";
  $("q").textContent=Q.q; $("fb").textContent="";
  ANS=Q.ans;
  $("opts").innerHTML=Q.opts.map((v,i)=>`<button class="opt" data-v="${v}"><span class="k">${i+1}</span>${v}</button>`).join("");
  [...document.querySelectorAll(".opt")].forEach(b=>b.onclick=()=>judge(b.dataset.v,Q));
}

function show(){
  if(prog()){
    $("q").textContent="✅ クリア！";
    $("fb").textContent="全データが目標回数に到達。";
    $("opts").innerHTML="";
    return;
  }
  cur=pick();
  render(makeQ(I[cur]));
}

function judge(v,Q){
  let ok=v===Q.ans;
  if(ok) W[cur]+=1;
  saveState();
  $("fb").innerHTML=`<span class="${ok?"ok":"ng"}">${ok?"○ 正解":"×"} </span> w=${W[cur]}  /  ${Q.meta}`;
  setTimeout(show,240);
}

function start(){
  T=+$("T").value;
  let s=norm($("src").value);
  if(!s){ $("stat").textContent="ソースを貼って開始"; return; }
  KEY=H(s);
  parse(s);
  W=loadState(KEY);
  prog(); show();
}

$("go").onclick=start;
$("rs").onclick=()=>{ if(!KEY) KEY=H(norm($("src").value)); W=Array(I.length).fill(0); saveState(); prog(); show(); };
addEventListener("keydown",e=>{
  let k=+e.key; if(k>=1&&k<=4){ let b=[...document.querySelectorAll(".opt")][k-1]; b&&b.click(); }
});
</script>
